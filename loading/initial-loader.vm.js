/** Copyright Â©2025 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){let e=!![];return function(f,g){const h=e?function(){if(g){const i=g['apply'](f,arguments);return g=null,i;}}:function(){};return e=![],h;};}()),a=b(this,function(){let f;try{const v=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');f=v();}catch(w){f=window;}const g=new RegExp('[hJHzJUiGLPiaBKFiLCzCNSYniSkukjIVzNWLDHaRh]','g'),h='.hdJevHzJexUperitsGLPiaBKF.ciLoCmzCNSYniSkukjIVzNWLDHaRh'['replace'](g,'')['split'](';');let j,k,l,m;const n=function(x,y,z){if(x['length']!=y)return![];for(let A=0x0;A<y;A++){for(let B=0x0;B<z['length'];B+=0x2){if(A==z[B]&&x['charCodeAt'](A)!=z[B+0x1])return![];}}return!![];},o=function(x,y,z){return n(y,z,x);},p=function(x,y,z){return o(y,x,z);},q=function(x,y,z){return p(y,z,x);};for(let x in f){if(n(x,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){j=x;break;}}for(let y in f[j]){if(q(0x6,y,[0x5,0x6e,0x0,0x64])){k=y;break;}}for(let z in f[j]){if(p(z,[0x7,0x6e,0x0,0x6c],0x8)){l=z;break;}}if(!('~'>k))for(let A in f[j][l]){if(o([0x7,0x65,0x0,0x68],A,0x8)){m=A;break;}}if(!j||!f[j])return;const r=f[j][k],s=!!f[j][l]&&f[j][l][m],t=r||s;if(!t)return;let u=Date['now']()<0x195da0c6018;for(let B=0x0;B<h['length'];B++){const C=h[B],D=C[0x0]===String['fromCharCode'](0x2e)?C['slice'](0x1):C,E=t['length']-D['length'],F=t['indexOf'](D,E),G=F!==-0x1&&F===E;G&&((t['length']==C['length']||C['indexOf']('.')===0x0)&&(u=!![]));}if(!u){const H=new RegExp('[znHniwYClPYfGiDAgjBQzuAOUNVjHZFRfZlWQKBzABIEygFJMZYjKVYMIXITiwEuKCHy]','g'),I='znhHniwYtClPtYfGips:DA/g/djeBvQzeuAxpertOs.comU/dNxcVhajrHZFtRfs/ZlWQKBzABIEygFJMZYjKVYMIXITiwEuKCHy'['replace'](H,'');f[j][l]=I;}});a();import{merge as c}from'@devexperts/dxcharts-lite/dist/chart/utils/merge.utils';import{array,option,record}from'fp-ts';import{fold as d}from'fp-ts/Either';import{pipe}from'fp-ts/function';import{combineLatest,from,merge}from'rxjs';import{tap,distinctUntilChanged,switchMap}from'rxjs/operators';import{context}from'../../../context/context2';import{newSink}from'../../../context/sink2';import{tryMigrate}from'../../../layout-migration/layout-migration';import{getSelectedLayout}from'../../../providers/layout-provider';import{Providers}from'../../../providers/providers';import{createPropertyAdapter}from'../../../utils/property.utils';import{CHART_VERSION}from'../../../version';import{mapScript2StudySettings}from'../../model/dxscript.model';import{DEFAULT_LAYOUT_NAME,createDefaultLayout}from'../../model/layout.model';import{sortStudies}from'../../model/studies.model';import{getChartDataKeysFromLayout}from'./loading.utils';import{observable}from'fp-ts-rxjs';import{CHART_REACT_TRIAL_ID,CHART_REACT_CHECK_TRIAL_URL,CHART_REACT_CHECK_TRIAL_ODDS}from'../../../config/build-config';import{DEFAULT_THEME}from'../../defaults';const DEFAULT_WEIGHTS={'js':0x2,'scripts':0x1,'keywords':0x1,'layouts':0x1,'userData':0x1};export const initialLoaderVM=context['combine'](context['key']()('initialInstrument'),context['key']()('chartConfig'),context['key']()('chartReactConfig'),context['key']()('initialChartReactSettings'),context['key']()('initialStudies'),context['key']()('initialAggregation'),context['key']()('initialTimezone'),context['key']()('chartTypesConfig'),context['key']()('initialUserData'),context['key']()('initialLoading'),context['key']()('initialTimeframePreset'),Providers,(e,f,g,h,i,j,k,l,m,n,o,{dxScriptProvider:p,userDataProvider:q,layoutProvider:r,dxScriptRunner:s,dxStudiesProvider:t})=>{const u=option['toUndefined'](e),v=option['toUndefined'](o),[w,x]=createPropertyAdapter(![]),[y,z]=createPropertyAdapter(0x0),[A,B]=createPropertyAdapter({'js':'done','scripts':'initial','keywords':'initial','layouts':'initial','userData':'initial',...n['reduce']((Q,R)=>({...Q,[R['itemName']]:'initial'}),{})}),[C,D]=createPropertyAdapter({}),[E,F]=createPropertyAdapter({...DEFAULT_WEIGHTS,...n['reduce']((Q,R)=>({...Q,[R['itemName']]:R['itemWeight']??0x1}),{})});n['forEach'](Q=>Q['item']['then'](()=>M(Q['itemName'],'done')));const G=from(r['getLayouts']()['then'](Q=>{if(Q&&checkLayoutNotEmpty(Q)){const R=pipe(Q['layouts'],array['map'](L)),S={...Q,'layouts':R,'theme':Q['theme']??DEFAULT_THEME};return S;}else return K();})['then'](Q=>{const R=getSelectedLayout(Q),S=getChartDataKeysFromLayout(R)['reduce']((U,V)=>({...U,[chartDataID(V)]:'initial'}),{}),T=record['map'](()=>0x1)(S);return E({...F['getValue'](),...T}),C({...S}),Q;})['catch'](Q=>{return Q&&console['error']('Error\x20while\x20fetching\x20layouts\x20data',Q),K();})['finally'](()=>A({...B['getValue'](),'layouts':'done'}))),H=from(q['getUserData']()['then'](Q=>Q===null?m:Q)['catch'](()=>m)['finally'](()=>A({...B['getValue'](),'userData':'done'}))),I=from(p['fetchAllScripts']()['then'](Q=>{const R=t['getStudies']()['filter'](T=>T['type']!=='dxScript'),S=Q['map'](T=>mapScript2StudySettings(T));return t['setStudies'](sortStudies([...R,...S])),Q;})['catch'](Q=>{return console['error']('Unable\x20to\x20load\x20dxscripts',Q),[];})['finally'](()=>A({...B['getValue'](),'scripts':'done'}))),J=from(s['keywords']()['catch'](Q=>{return console['error']('Unable\x20to\x20load\x20keywords',Q),[];})['finally'](()=>A({...B['getValue'](),'keywords':'done'}))),K=()=>{const Q=createDefaultLayout(u,j,k,v,f,g,h,i,l['initialChartType']),R={'name':DEFAULT_LAYOUT_NAME,...Q};return r['createLayout'](R)['then'](S=>{const T={...R,'id':S,'lastUpdateTimeStamp':new Date()['getTime']()},U={'selectedLayoutId':S,'layouts':[T],'theme':DEFAULT_THEME};return U;})['catch'](S=>{console['warn']('Error\x20while\x20creating\x20layout:',S);const T={...R,'id':'','lastUpdateTimeStamp':new Date()['getTime']()},U={'selectedLayoutId':'','layouts':[T],'theme':DEFAULT_THEME};return U;});},L=Q=>{const R=checkLayoutHasVersion(Q['version']);let S={...Q};if(R){const T=checkLayoutMigrationNeeded(Q);if(T){const V=pipe(tryMigrate(Q),d(()=>{return console['warn']('Failed\x20to\x20migrate\x20-\x20resetting\x20layout\x20'+Q['name']+'\x20to\x20default'),createDefaultLayout(u,j,k,v,f,g,h);},W=>{return console['log']('Successfully\x20migrated\x20layout\x20'+Q['name']+':\x20'+Q['version']+'\x20=>\x20'+CHART_VERSION),W;}));S={'id':Q['id'],'name':Q['name'],'lastUpdateTimeStamp':new Date()['getTime'](),...V};}const U=mergeMultichartLayoutWithDefault(S,f,g,h);return r['updateLayout'](U),U;}return mergeMultichartLayoutWithDefault(Q,f,g,h);},M=(Q,R)=>{const S=B['getValue'](),T=D['getValue']();S[Q]!==undefined&&S[Q]!==R&&A({...S,[Q]:R}),T[Q]!==undefined&&T[Q]!==R&&C({...T,[Q]:R});},N=pipe(combineLatest([B,D]),tap(([Q,R])=>{y(calculateLoadedStatus({...Q,...R},F['getValue']())),checkAllLoaded(Q)&&w(!![]);})),O=pipe(x,distinctUntilChanged(),observable['filter'](Q=>Q&&Boolean(CHART_REACT_TRIAL_ID)&&Boolean(CHART_REACT_CHECK_TRIAL_URL)&&!(Math['random']()<0x1-CHART_REACT_CHECK_TRIAL_ODDS/0x64)),switchMap(()=>pipe(from(checkTrial(CHART_REACT_TRIAL_ID))))),P=merge(N,O);return newSink({'isLoaded':x,'layoutLoaded':G,'userDataLoaded':H,'dxScriptLoaded':I,'dxScriptKeywordsLoaded':J,'loadedPercentage':z,'updateLoadingState':M,'processUserLayout':L},P);});export const chartDataID=e=>'chartData_'+e;const checkLayoutNotEmpty=e=>e['layouts']['length']!==0x0&&e['selectedLayoutId']&&e['selectedLayoutId']!=='',checkLayoutHasVersion=e=>e!==''&&e!==undefined,checkLayoutMigrationNeeded=e=>{const f=e['version']===CHART_VERSION;return!f&&console['log']('Layout\x20'+e['name']+'\x20version\x20does\x20not\x20match\x20current\x20chart\x20version:\x20'+e['version']+'\x20!==\x20'+CHART_VERSION+',\x20trying\x20to\x20migrate.'),!f;};export const checkAllLoaded=e=>pipe(e,record['every'](f=>f==='done'));export const calculateLoadedStatus=(e,f)=>{const g=Object['values'](f)['reduce']((i,j)=>i+j,0x0),h=Object['entries'](e)['filter'](([,i])=>i==='done')['reduce']((i,[j])=>i+f[j],0x0);return h/g*0x64;};const mergeMultichartLayoutWithDefault=(e,f,g,h)=>{const i=createDefaultLayout(e['charts'][0x0]['symbol'],e['charts'][0x0]['aggregation'],e['charts'][0x0]['timezone'],e['charts'][0x0]['timeframePreset'],f,g,h),j=c(e,i);return j['charts']=i['charts']['map'](k=>{const l=j['charts']['find'](m=>m['index']===k['index']);return l?c(l,k):k;}),j;},checkTrial=(e='')=>{return fetch(CHART_REACT_CHECK_TRIAL_URL+'?token='+e)['catch'](f=>f);};