/** Copyright Â©2025 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
import{firstOf,lastOf}from'@devexperts/dxcharts-lite/dist/chart/utils/array.utils';import{deepEqual}from'@devexperts/dxcharts-lite/dist/chart/utils/object.utils';import{constUndefined,constVoid,pipe}from'fp-ts/function';import{Subject,merge}from'rxjs';import{tap}from'rxjs/operators';import{generateSessionsStrict}from'../../utils/session.utils';import{createMutex}from'./mutex';let resolve=null;export const createStudiesCalculator=new Promise(a=>resolve=a);export const studiesLoaded=import('@dx-private/dxstudies/dxstudies')['then'](a=>{const b=(c=Number['MAX_SAFE_INTEGER'],d=[])=>{if(!a)throw new Error();const e=a['default']?a['default']['com']['devexperts']['dxst']['DxStudies']:a['DxStudies'];return new e(c,d);};resolve(b);})['catch'](()=>console['warn']('dxStudies\x20module\x20isn\x27t\x20available'));export class DxStudiesDataProvider{constructor(a,b,c=constUndefined){this['chartModel']=a,this['tradingSessionsProvider']=b,this['tradingHoursProvider']=c,this['studiesCalculator']=dxStudiesMock,this['fullStudiesCalculator']=dxStudiesMock,this['dxStudyConfigs']={},this['dxStudyCache']={},this['lastCandleTimeStamp']=0x0,this['lastCandleIdx']=0x0,this['seriesLengthWithFake']=0x0,this['studyUpdates']=new Subject(),this['studyHistory']=new Subject();const d=createMutex();merge(pipe(merge(this['chartModel']['candlesSetSubject'],this['chartModel']['candlesPrependSubject']),tap(()=>d['calculateSafe'](()=>this['initStudiesCalculators']()))),this['chartModel']['candlesUpdatedSubject']['pipe'](tap(()=>d['calculateSafe'](()=>this['updateCalculators']()))))['subscribe']();}async['initStudiesCalculators'](){try{const a=this['chartModel']['getCandles'](),b=this['chartModel']['getCandlesWithFake']();this['seriesLengthWithFake']=b['length'];const c=lastOf(a);this['lastCandleTimeStamp']=c?.['timestamp']??0x0,this['lastCandleIdx']=c?.['idx']??0x0;const d=a['map'](toStudiesCandle),f=b['map'](toStudiesCandle);this['studiesCalculator']=(await createStudiesCalculator)(Number['MAX_SAFE_INTEGER'],d),this['fullStudiesCalculator']=(await createStudiesCalculator)(Number['MAX_SAFE_INTEGER'],f),this['dxStudyCache']={};const g=this['tradingHoursProvider']();g!==undefined&&await this['applySessions'](g,a,b),Object['values'](this['dxStudyConfigs'])['forEach'](h=>{this['applyStudyConfig'](h);});}catch(h){console['warn'](h);}}['applyStudyConfig'](a){const b=!deepEqual(a['parameters'],this['dxStudyConfigs'][a['uuid']]?.['parameters']),c=a['overlaying']!==this['dxStudyConfigs'][a['uuid']]?.['overlaying'];if(!this['dxStudyCache'][a['uuid']]||b){this['dxStudyConfigs'][a['uuid']]=a;const d=a['parameters']['map'](f=>({'key':f['id'],'value':f['value']}));let e=this['dxStudyCache'][a['uuid']];(e===undefined||b)&&(a['calculateFutureData']?e=this['fullStudiesCalculator']['createStudy'](a['id'],d):e=this['studiesCalculator']['createStudy'](a['id'],d),this['dxStudyCache'][a['uuid']]=e),this['studyHistory']['next']({[a['uuid']]:e['calculateAll']()??[[]]});}else this['dxStudyCache'][a['uuid']]&&c&&(this['dxStudyConfigs'][a['uuid']]['overlaying']=a['overlaying'],this['studyHistory']['next']({[a['uuid']]:this['dxStudyCache'][a['uuid']]['calculateAll']()??[[]]}));}['setStudyConfigs'](a){try{a['forEach'](c=>{this['applyStudyConfig'](c);});const b=Object['keys'](this['dxStudyConfigs'])['filter'](c=>!a['find'](d=>d['uuid']===c));b['forEach'](c=>{delete this['dxStudyConfigs'][c],delete this['dxStudyCache'][c];});}catch(c){console['warn'](c);}}async['updateCalculators'](){const a=this['chartModel']['getCandlesAfter'](this['lastCandleTimeStamp']),b=firstOf(a)?.['timestamp']===this['lastCandleTimeStamp'],c=a['length']-(b?0x1:0x0);this['addFakeCandleIfNeeded'](a,c);const d=[];for(const e of a){d['push'](toStudiesCandle(e));}a['length']>0x0&&(this['lastCandleTimeStamp']=lastOf(a)?.['timestamp']??0x0,this['studiesCalculator']['addCandleItems'](d),this['fullStudiesCalculator']['addCandleItems'](d),this['calculateOnlyLastValues'](this['lastCandleIdx'],c));}['calculateOnlyLastValues'](a,b){const c=a+b;this['lastCandleIdx']=c;const d={};for(const [e,f]of Object['entries'](this['dxStudyCache'])){d[e]=[];const g=this['dxStudyConfigs'][e]?.['calculateFutureData']?this['seriesLengthWithFake']:c;for(let h=a;h<=g;h++){d[e]['push'](f['calculateAt'](h));}}this['studyUpdates']['next'](d);}['addFakeCandleIfNeeded'](a,b){const c=lastOf(a);if(c?.['idx']!==this['lastCandleIdx']){const d=this['chartModel']['getCandlesWithFake']();this['seriesLengthWithFake']+=b;const e=lastOf(d);if(e!==undefined){const f=[e]['map'](toStudiesCandle);this['fullStudiesCalculator']['addCandleItems'](f);}}}async['applySessions'](a,b,c){const d=lastOf(c)?.['timestamp'],e=firstOf(c)?.['timestamp'];if(d===undefined||e===undefined)return;const f=['REGULAR','PRE_MARKET','AFTER_MARKET'],g=0x3c*0x3c*0x18*0x3e8,h=[],i=this['chartModel']['mainCandleSeries']['instrument']['symbol'];this['chartModel']['getPeriod']()<g&&i?h['push'](...await generateSessionsStrict(this['tradingSessionsProvider'],e,d,{'filter':f,'candles':b,'tradingHours':a,'period':this['chartModel']['getPeriod'](),'symbol':i})):b['forEach']((k,l)=>{const m=b[l+0x1];k&&m&&h['push']({'from':k['timestamp'],'to':m['timestamp'],'type':'REGULAR'});});const j=h['map'](toStudiesSession);this['studiesCalculator']['setTradingSessions'](j),this['fullStudiesCalculator']['setTradingSessions'](j);}}export const toStudiesSession=a=>({'getFrom':()=>a['from'],'getTo':()=>a['to']});export const toStudiesCandle=a=>({'time':a['timestamp'],'getOpen':()=>a['open'],'getClose':()=>a['close'],'getTime':()=>a['timestamp'],'getIsVisible':()=>!![],'getHigh':()=>a['hi'],'getLow':()=>a['lo'],'getImpVolatility':()=>a['impVolatility'],'getVolume':()=>a['volume'],'getVwap':()=>a['vwap']});export const dxStudiesMock={'createStudy':a=>({'id':a,'title':null,'parameters':[],'lines':[],'overlaying':null,'categories':null,'uiid':null,'calculateAll':()=>[[]],'calculateAt':()=>[]}),'addCandleItems':constVoid,'setTradingSessions':constVoid};