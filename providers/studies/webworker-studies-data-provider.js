/** Copyright Â©2025 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
import{deepEqual}from'@devexperts/dxcharts-lite/dist/chart/utils/object.utils';import{firstOf,lastOf}from'@devexperts/dxcharts-lite/dist/chart/utils/array.utils';import{fakeCandle}from'@devexperts/dxcharts-lite/dist/chart/components/chart/fake-candles';import{createStudiesCalculator,dxStudiesMock,toStudiesCandle,toStudiesSession}from'./dx-studies-studies-data-provider';import{generateSessionsStrict}from'../../utils/session.utils';const FAKE_CANDLES_DEFAULT=0x64;export class DxStudiesDataProvider{constructor(a,b,c,d,e){this['studiesCalculator']=dxStudiesMock,this['fullStudiesCalculator']=dxStudiesMock,this['dxStudyConfigs']={},this['dxStudyCache']={},this['lastCandleTimeStamp']=0x0,this['lastCandleIdx']=0x0,this['seriesLengthWithFake']=0x0,this['chartModel']=null,this['tradingSessionsProvider']=null,this['tradingHoursProvider']=null,this['historyDataCallback']=null,this['updateDataCallback']=null,this['chartModel']=a,this['tradingSessionsProvider']=b,this['tradingHoursProvider']=c,this['historyDataCallback']=d,this['updateDataCallback']=e;}async['candlesWithFake'](a){const b=await this['chartModel']['getPeriod']();return getCandlesWithFake(a,b);}async['initStudiesCalculators'](){try{const a=await this['chartModel']['getCandles'](),b=await this['candlesWithFake'](a);this['seriesLengthWithFake']=b['length'];const c=lastOf(a);this['lastCandleTimeStamp']=c?.['timestamp']??0x0,this['lastCandleIdx']=c?.['idx']??0x0;const d=a['map'](toStudiesCandle),f=b['map'](toStudiesCandle);this['studiesCalculator']=(await createStudiesCalculator)(Number['MAX_SAFE_INTEGER'],d),this['fullStudiesCalculator']=(await createStudiesCalculator)(Number['MAX_SAFE_INTEGER'],f),this['dxStudyCache']={};const g=await this['tradingHoursProvider']();g!==undefined&&await this['applySessions'](g,a,b),Object['values'](this['dxStudyConfigs'])['forEach'](h=>{this['applyStudyConfig'](h);});}catch(h){console['warn'](h);}}async['updateCalculators'](){if(this['lastCandleTimeStamp']===0x0){console['warn']('updateCalculators:\x20lastCandleTimeStamp\x20is\x200.\x20Race\x20condition:\x20update\x20was\x20executed\x20earlier\x20than\x20init.');return;}const a=await this['chartModel']['getCandlesAfter'](this['lastCandleTimeStamp']),b=a['filter'](d=>d['timestamp']!==this['lastCandleTimeStamp'])['length'];this['addFakeCandleIfNeeded'](a,b);const c=[];for(const d of a){c['push'](toStudiesCandle(d));}a['length']>0x0&&(this['lastCandleTimeStamp']=lastOf(a)?.['timestamp']??0x0,this['studiesCalculator']['addCandleItems'](c),this['fullStudiesCalculator']['addCandleItems'](c),await this['calculateOnlyLastValues'](this['lastCandleIdx'],b));}async['calculateOnlyLastValues'](a,b){const c=a+b;this['lastCandleIdx']=c;const d={};for(const [e,f]of Object['entries'](this['dxStudyCache'])){d[e]=[];const g=this['dxStudyConfigs'][e]?.['calculateFutureData']?this['seriesLengthWithFake']:c;for(let h=a;h<=g;h++){d[e]['push'](f['calculateAt'](h));}}await this['updateDataCallback'](d);}async['addFakeCandleIfNeeded'](a,b){const c=lastOf(a);if(c?.['idx']!==this['lastCandleIdx']){const d=await this['candlesWithFake'](a);this['seriesLengthWithFake']+=b;const e=lastOf(d);if(e!==undefined){const f=[e]['map'](toStudiesCandle);this['fullStudiesCalculator']['addCandleItems'](f);}}}['applyStudyConfig'](a){const b=!deepEqual(a['parameters'],this['dxStudyConfigs'][a['uuid']]?.['parameters']),c=a['overlaying']!==this['dxStudyConfigs'][a['uuid']]?.['overlaying'];if(!this['dxStudyCache'][a['uuid']]||b){this['dxStudyConfigs'][a['uuid']]=a;const d=a['parameters']['map'](f=>({'key':f['id'],'value':f['value']}));let e=this['dxStudyCache'][a['uuid']];(e===undefined||b)&&(a['calculateFutureData']?e=this['fullStudiesCalculator']['createStudy'](a['id'],d):e=this['studiesCalculator']['createStudy'](a['id'],d),this['dxStudyCache'][a['uuid']]=e),this['historyDataCallback']({[a['uuid']]:e['calculateAll']()??[[]]});}else this['dxStudyCache'][a['uuid']]&&c&&(this['dxStudyConfigs'][a['uuid']]['overlaying']=a['overlaying'],this['historyDataCallback']({[a['uuid']]:this['dxStudyCache'][a['uuid']]['calculateAll']()??[[]]}));}['setStudyConfigs'](a){try{a['forEach'](c=>{this['applyStudyConfig'](c);});const b=Object['keys'](this['dxStudyConfigs'])['filter'](c=>!a['find'](d=>d['uuid']===c));b['forEach'](c=>{delete this['dxStudyConfigs'][c],delete this['dxStudyCache'][c];});}catch(c){console['warn'](c);}}async['applySessions'](a,b,c){const d=lastOf(c)?.['timestamp'],e=firstOf(c)?.['timestamp'];if(d===undefined||e===undefined)return;const f=['REGULAR','PRE_MARKET','AFTER_MARKET'],g=0x3c*0x3c*0x18*0x3e8,h=[],i=await this['chartModel']['getPeriod'](),j=await this['chartModel']['mainCandleSeries']['instrument']['symbol'];i<g&&j?h['push'](...await generateSessionsStrict(await this['tradingSessionsProvider'],e,d,{'filter':f,'candles':b,'tradingHours':a,'period':i,'symbol':j})):b['forEach']((l,m)=>{const n=b[m+0x1];l&&n&&h['push']({'from':l['timestamp'],'to':n['timestamp'],'type':'REGULAR'});});const k=h['map'](toStudiesSession);this['studiesCalculator']['setTradingSessions'](k),this['fullStudiesCalculator']['setTradingSessions'](k);}}const getCandlesWithFake=(a,b)=>{const c=a['slice'](),d=c['length']+FAKE_CANDLES_DEFAULT;for(let e=c['length'];e<d;e++){c['push'](fakeCandle(c,e,b));}return c;};