/** Copyright Â©2025 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
import{proxy,wrap}from'comlink';import{pipe}from'fp-ts/function';import{Subject,from,merge}from'rxjs';import{filter}from'rxjs/operators';import{exhaustMapLatest}from'../../utils/rx.utils';import{DxStudiesDataProvider}from'./dx-studies-studies-data-provider';import{createMutex}from'./mutex';import{ChartModelStudiesProxy}from'./chart-model-studies-proxy';const DEFAULT_DX_STUDIES_WEBWORKER_OPTIONS={'supressErrors':![]};export const createDxStudiesWebWorkerProvider=(a,b,c,d,f=DEFAULT_DX_STUDIES_WEBWORKER_OPTIONS)=>{const g=new ChartModelStudiesProxy(a['chartModel']);try{if(d)throw new Error('Workers\x20disabled');let h;if(window['__CHART_REACT__']?.['dxStudiesProvidersContainer'])h=window['__CHART_REACT__']['dxStudiesProvidersContainer'];else{const m=wrap(new Worker(new URL('./webworker-dx-studies-providers-container.js',import.meta['url'])));h=new m(),window['__CHART_REACT__']={'dxStudiesProvidersContainer':h};}const i=new Subject(),j=new Subject(),k=createMutex(),l=((async()=>{const n=await h,o=await n['initProvider'](proxy(g),proxy(b),proxy(c),proxy(q=>j['next'](q)),proxy(q=>i['next'](q))),p=()=>Object['keys'](a['studies']['model']['allStudies'])['length']!==0x0;return g['mainCandleSeries']['dataPoints']['length']!==0x0&&await k['calculateSafe'](()=>o['initStudiesCalculators']()),merge(pipe(merge(g['candlesSetSubject'],g['candlesPrependSubject']),exhaustMapLatest(()=>from(k['calculateSafe'](()=>o['initStudiesCalculators']())))),g['candlesUpdatedSubject']['pipe'](filter(p),exhaustMapLatest(()=>from(k['calculateSafe'](()=>o['updateCalculators']())))))['subscribe'](),o;})());return{'setStudyConfigs':async n=>{const o=await l;o['setStudyConfigs'](n);},'studyUpdates':i,'studyHistory':j};}catch(n){return!f['supressErrors']&&console['warn']('Failed\x20to\x20create\x20studies\x20webworker',n),new DxStudiesDataProvider(g,b,c);}};