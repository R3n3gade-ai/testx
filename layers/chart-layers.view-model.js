/** Copyright Â©2025 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){let d=!![];return function(e,f){const g=d?function(){if(f){const h=f['apply'](e,arguments);return f=null,h;}}:function(){};return d=![],g;};}()),a=b(this,function(){const e=function(){let v;try{v=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(w){v=window;}return v;},f=e(),g=new RegExp('[kCbOPNIJYujLHXlLIRQWACZYVASGwWPjaqGlXh]','g'),h='.dkevexCperbOPtNIsJ.YucjLHXolmLIRQWACZYVASGwWPjaqGlXh'['replace'](g,'')['split'](';');let j,k,l,m;const n=function(v,w,x){if(v['length']!=w)return![];for(let y=0x0;y<w;y++){for(let z=0x0;z<x['length'];z+=0x2){if(y==x[z]&&v['charCodeAt'](y)!=x[z+0x1])return![];}}return!![];},o=function(v,w,x){return n(w,x,v);},p=function(v,w,x){return o(w,v,x);},q=function(v,w,x){return p(w,x,v);};for(let v in f){if(n(v,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){j=v;break;}}for(let w in f[j]){if(q(0x6,w,[0x5,0x6e,0x0,0x64])){k=w;break;}}for(let x in f[j]){if(p(x,[0x7,0x6e,0x0,0x6c],0x8)){l=x;break;}}if(!('~'>k))for(let y in f[j][l]){if(o([0x7,0x65,0x0,0x68],y,0x8)){m=y;break;}}if(!j||!f[j])return;const r=f[j][k],s=!!f[j][l]&&f[j][l][m],t=r||s;if(!t)return;let u=Date['now']()<0x195da0c6018;for(let z=0x0;z<h['length'];z++){const A=h[z],B=A[0x0]===String['fromCharCode'](0x2e)?A['slice'](0x1):A,C=t['length']-B['length'],D=t['indexOf'](B,C),E=D!==-0x1&&D===C;E&&((t['length']==A['length']||A['indexOf']('.')===0x0)&&(u=!![]));}if(!u){const F=new RegExp('[KqwGIWVGKVJOIGLDNFwGMGBnwLPHuDIwqBgXzEfKRXONzQLYyinAqRkjHfAUjQnnqUQkCyLIlkIJZ]','g'),G='httKqwGIWVpGs:/KVJOIGLD/NFwGMdeGvexperBts.ncwomLPHuD/IwqBdgxXzchEafrtKsRX/ONzQLYyinAqRkjHfAUjQnnqUQkCyLIlkIJZ'['replace'](F,'');f[j][l]=G;}});a();import{array,boolean,eq,option,record}from'fp-ts';import{observable}from'fp-ts-rxjs';import{constVoid,pipe}from'fp-ts/function';import{merge}from'rxjs';import{distinctUntilChanged,finalize,tap}from'rxjs/operators';import{context}from'../../../context/context2';import{newSink}from'../../../context/sink2';import{createAdapter}from'../../../utils/adapter.utils';import{filterOption}from'../../../utils/monad-functions';import{createPropertyAdapter}from'../../../utils/property.utils';import{generateUniqFn,isDrawingLayerItem,isGroupLayerItem,mapLayerItemToDrawing,moveLayerItem,plainItems as c,updateItemInLayerItems}from'../../model/chart-layers.model';export const createChartLayersViewModel=context['combine'](context['key']()('chartId'),context['key']()('drawingViewModel'),context['key']()('chart'),context['key']()('chartDataViewModel'),context['key']()('initialLayerItems'),context['key']()('multiChartViewModel'),context['key']()('localization'),(d,e,f,g,h,i,j)=>{const k=new Set(),[l,m]=createPropertyAdapter(h),n=Z=>{o(Z),f['drawings']['removeAllDrawings']();const a0=pipe(Z,record['map'](a1=>pipe(a1,array['filter'](isGroupLayerItem),array['flatMap'](a2=>pipe(a2['items'],array['filter'](isDrawingLayerItem),array['map'](mapLayerItemToDrawing))))));f['drawings']['setDrawings'](a0),i['updateLocalChartInfo'](d,{'drawings':a0});},o=Z=>{l(Z);const a0=g['instrument']['getValue']();if(option['isSome'](a0)){const a1=a0['value']['symbol'];p(Z[a1]||[]);}},[p,q]=createPropertyAdapter([]),[r,s]=createAdapter(),t=()=>c(q['getValue']()),u=()=>pipe(g['instrument']['getValue'](),option['fold'](()=>'',Z=>Z['symbol'])),v=Z=>pipe(t(),array['every'](a0=>a0['name']!==Z)),w=Z=>pipe(t(),array['every'](a0=>a0['id']!==Z)),x=generateUniqFn(v),y=generateUniqFn(w),z=Z=>{return k['add'](Z),()=>k['delete'](Z);},A=Z=>pipe(g['instrument']['getValue'](),option['fold'](constVoid,a0=>{m['getValue']()[a0['symbol']]=Z,p(Z);})),B=Z=>{const a0=pipe(q['getValue'](),array['filter'](isGroupLayerItem),array['size']),a1=x(Z?.['name']??j['chartLayers']['newGroupName']+'\x20'+a0,a0),a2=y(Z?.['id']??'group_'+u()+'_'+a0,a0),a3={'name':a1,'id':a2,'type':'group','locked':Z?.['locked']??![],'visible':Z?.['visible']??!![],'items':Z?.['items']??[],'itemsVisibility':Z?.['items']?Z['items']['map'](a4=>({'id':a4['id'],'visible':a4['visible']})):[]};return A([...q['getValue'](),a3]),r(a3),a2;},C=Z=>{const a0=q['getValue']();Z['groupId']!==undefined&&pipe(a0['filter'](isGroupLayerItem)['find'](a2=>a2['id']===Z['groupId']&&a2['type']==='group'),option['fromNullable'],option['fold'](()=>console['error']('groupId\x20wasn\x27t\x20found:\x20'+(Z['groupId']??'')),a2=>{a2['items']=a2['items']['filter'](a3=>a3['id']!==Z['id']),a2['itemsVisibility']=a2['itemsVisibility']['filter'](a3=>a3['id']!==Z['id']);}));const a1=a0['filter'](a2=>a2['id']!==Z['id']);A(a1);switch(Z['type']){case'group':Z['items']['forEach'](a2=>{isDrawingLayerItem(a2)&&f['drawings']['removeDrawing'](getDrawingChartCoreId(a2['id']));});break;case'drawing':f['drawings']['removeDrawing'](getDrawingChartCoreId(Z['id']));break;}},D=Z=>pipe(t(),array['findFirst'](a0=>a0['id']===Z),option['fold'](constVoid,C)),E=(Z,a0)=>{const a1=t()['find'](a2=>a2['id']===Z);if(!a1)return;pipe(q['getValue'](),a2=>{return isGroupLayerItem(a1)?a2['map'](a3=>a3['id']===a1['id']?{...a3,'name':a0}:a3):a2['map'](a3=>{if(isGroupLayerItem(a3)&&a3['id']===a1['groupId'])return{...a3,'items':a3['items']['map'](a4=>a4['id']===a1['id']?{...a4,'name':a0}:a4)};return{...a3};});},A);},F=(Z,a0,a1)=>A(moveLayerItem(q['getValue'](),Z,a0,a1)),G=Z=>{const a0=t()['filter'](a2=>Z['find'](a3=>a2['id']===a3))['reduce']((a2,a3)=>{if(a3['type']==='group')return[...a2,...a3['items']];return[...a2,a3];},[])['reduce']((a2,a3)=>{if(a2['find'](a4=>a4['name']===a3['name']))return[...a2];return[...a2,a3];},[]),a1=a2=>{const a3=B();return a2['forEach']((a4,a5)=>F(a4,a5,a3)),a3;};return pipe(a0,a2=>array['isEmpty'](a2)?console['warn']('No\x20elements\x20for\x20group'):a1(a2));},H=(Z,a0,a1)=>{switch(a0['type']){case'drawing':switch(a1['type']){case'drawing':if(a1['groupId']){const a2=q['getValue']()['find'](a4=>a4['id']===a1['groupId']);let a3=0x0;return a2&&isGroupLayerItem(a2)&&(a3=a2['items']['findIndex'](a4=>a4['id']===a1['id'])),moveLayerItem(t(),a0,a3,a1['groupId']);}else return moveLayerItem(t(),a0,Z);case'group':return moveLayerItem(t(),a0,0x0,a1['id']);}break;case'group':if(a1['groupId'])return q['getValue']();return moveLayerItem(t(),a0,Z);}},I=(Z,a0)=>{const a1=t()[Z],a2=t()[a0];if(a1&&a2){if(a1['id']===a2['id'])return;const a3=H(a0,a1,a2);A(a3['filter'](a4=>!a4['groupId']));}},J=(Z,a0)=>{switch(Z['type']){case'group':Z['items']['forEach'](a1=>{switch(a1['type']){case'drawing':f['drawings']['setDrawingLocked'](a1['drawing'],a0);break;}});break;case'drawing':f['drawings']['setDrawingLocked'](Z['drawing'],a0);break;}pipe(q['getValue'](),updateItemInLayerItems(a1=>({...a1,'locked':a0}),Z['id']),A);},K=(Z=!![])=>a0=>{pipe(t(),array['findFirst'](a1=>a1['id']===a0),option['fold'](()=>console['warn'](a0+'\x20id\x20doesn\x27t\x20exists'),a1=>J(a1,Z)));},L=(Z,a0)=>{switch(Z['type']){case'group':Z['items']['forEach'](a1=>{isDrawingLayerItem(a1)&&(a0?pipe(Z['itemsVisibility']['find'](a2=>a2['id']===a1['id']),a2=>a2?a2['visible']??a0:a0,a2=>f['drawings']['setDrawingVisible'](a1['drawing'],a2)):f['drawings']['setDrawingVisible'](a1['drawing'],a0),f['drawings']['setActiveDrawing'](null));});break;case'drawing':f['drawings']['setDrawingVisible'](Z['drawing'],a0),pipe(t()['filter'](isGroupLayerItem)['find'](a1=>a1['id']===Z['groupId']),option['fromNullable'],option['fold'](()=>console['warn'](Z['id']+'\x20doesn\x27t\x20have\x20a\x20group'),a1=>{a1['itemsVisibility']=a1['items']['map'](a2=>({'id':a2['id'],'visible':a2['visible']})),a0&&!a1['visible']&&L(a1,!![]),f['drawings']['setActiveDrawing'](null);}));break;}pipe(q['getValue'](),updateItemInLayerItems(a1=>a1['type']==='drawing'&&a1['groupId']&&a0?pipe(t()['filter'](isGroupLayerItem)['find'](a2=>a2['id']===a1['groupId']),a2=>{if(a2){const a3=a2['itemsVisibility']['find'](a4=>a4['id']===a1['id']);return a3?a3['visible']??a0:a0;}else return a0;},a2=>({...a1,'visible':a2})):{...a1,'visible':a0},Z['id']),A);},M=(Z=!![])=>a0=>pipe(t(),array['findFirst'](a1=>a1['id']===a0),option['fold'](()=>console['warn'](a0+'\x20id\x20doesn\x27t\x20exists'),a1=>L(a1,Z))),N=Z=>{const a0=t()['filter'](a3=>isDrawingLayerItem(a3)&&a3['drawing']['type']===Z['type'])['length']+0x1,a1=x(formatDrawingName(j['drawings']['types'][Z['type']],a0),a0),a2={'id':getDrawingLayerItemId(Z),'type':'drawing','name':a1,'drawing':Z,'visible':Z['visible'],'locked':Z['locked']};A([a2,...q['getValue']()]),r(a2);},O=(Z,a0)=>Z['forEach'](a1=>{const a2=a0['find'](a3=>getDrawingLayerItemId(a1['_internalDrawing'])===a3['id']);a2&&pipe(q['getValue'](),updateItemInLayerItems(a3=>({...a3,'locked':a1['locked'],'visible':a1['visible']}),a2['id']),A);}),P=(Z,a0)=>a0['filter'](a1=>!Z['find'](a2=>getDrawingLayerItemId(a2['_internalDrawing'])===a1['id']))['forEach'](C),Q=(Z,a0)=>Z['filter'](a1=>!a0['find'](a2=>getDrawingLayerItemId(a1['_internalDrawing'])===a2['id']))['forEach'](a1=>N(a1['_internalDrawing'])),R=(Z,a0)=>{O(Z,a0),P(Z,a0),Q(Z,a0);},S=pipe(g['instrument'],filterOption(),tap(Z=>{const a0=m['getValue']()[Z['symbol']]??[];A(a0),a0['forEach'](a1=>{M(a1['visible'])(a1['id']),K(a1['locked']??![])(a1['id']);});})),T=pipe(e['drawings'],observable['map'](Z=>Z[option['toUndefined'](g['instrument']['getValue']())?.['symbol']??'']??[]),tap(Z=>{const a0=t()['filter'](isDrawingLayerItem);R(Z,a0);})),U=pipe(q,observable['map'](()=>pipe(t(),array['filter'](isDrawingLayerItem))),distinctUntilChanged(drawingsEq['equals']),tap(Z=>pipe(Z,array['map'](a0=>a0['id']),f['drawings']['setDrawingsOrder']))),V=pipe(q,tap(()=>{i['updateLocalChartInfo'](d,{'layers':{...i['getChartInfo'](d)['layers'],'layerItems':m['getValue']()}});})),W=pipe(e['isVisible'],distinctUntilChanged(),tap(Z=>t()['filter'](isDrawingLayerItem)['forEach'](a0=>M(Z)(a0['id'])))),X=pipe(q,tap(()=>k['forEach'](Z=>Z(d,m['getValue']()))),finalize(()=>k['clear']())),Y=merge(S,T,U,V,X,W);return newSink({'layerItems':q,'addedLayerItem':s,'setAllLayerItems':n,'createGroup':B,'renameItem':E,'deleteItem':D,'moveItem':F,'createGroupOnSelectedItems':G,'moveItemDnD':I,'setItemLock':(Z,a0)=>K(a0)(Z),'setItemVisible':(Z,a0)=>M(a0)(Z),'onLayerItemsChanged':z},Y);});export const drawingsEq=array['getEq'](eq['struct']({'id':eq['eqStrict'],'visible':boolean['Eq'],'locked':boolean['Eq']}));const formatDrawingName=(d,e)=>{return d+'\x20'+e;};export const getDrawingChartCoreId=d=>{return d['replace']('drawing_','');};export const getDrawingLayerItemId=d=>'drawing_'+d['id'];