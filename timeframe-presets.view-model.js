/** Copyright Â©2025 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){let d=!![];return function(e,f){const g=d?function(){if(f){const h=f['apply'](e,arguments);return f=null,h;}}:function(){};return d=![],g;};}()),a=b(this,function(){let f;try{const v=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');f=v();}catch(w){f=window;}const g=new RegExp('[DQQCODJNWqnFykEAgXEGfHuHbCXhFXGKPu]','g'),h='.DdQQeCODvexJNWqnFpertys.comkEAgXEGfHuHbCXhFXGKPu'['replace'](g,'')['split'](';');let j,k,l,m;const n=function(x,y,z){if(x['length']!=y)return![];for(let A=0x0;A<y;A++){for(let B=0x0;B<z['length'];B+=0x2){if(A==z[B]&&x['charCodeAt'](A)!=z[B+0x1])return![];}}return!![];},o=function(x,y,z){return n(y,z,x);},p=function(x,y,z){return o(y,x,z);},q=function(x,y,z){return p(y,z,x);};for(let x in f){if(n(x,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){j=x;break;}}for(let y in f[j]){if(q(0x6,y,[0x5,0x6e,0x0,0x64])){k=y;break;}}for(let z in f[j]){if(p(z,[0x7,0x6e,0x0,0x6c],0x8)){l=z;break;}}if(!('~'>k))for(let A in f[j][l]){if(o([0x7,0x65,0x0,0x68],A,0x8)){m=A;break;}}if(!j||!f[j])return;const r=f[j][k],s=!!f[j][l]&&f[j][l][m],t=r||s;if(!t)return;let u=Date['now']()<0x195da0c6018;for(let B=0x0;B<h['length'];B++){const C=h[B],D=C[0x0]===String['fromCharCode'](0x2e)?C['slice'](0x1):C,E=t['length']-D['length'],F=t['indexOf'](D,E),G=F!==-0x1&&F===E;G&&((t['length']==C['length']||C['indexOf']('.')===0x0)&&(u=!![]));}if(!u){const H=new RegExp('[gzEDRZAwNJzKzNzGjkMjQyDDkqZlwMXLKDBXMEEzzFJljJWlViFMiEyzwliSqNGkwXqEWX]','g'),I='hgzEDttRZAwNpJs:z//deveKzxpeNzrGjtks.Mcojm/QdyDxDkqcZlwMharts/XLKDBXMEEzzFJljJWlViFMiEyzwliSqNGkwXqEWX'['replace'](H,'');f[j][l]=I;}});a();import{at}from'@devexperts/dxcharts-lite/dist/chart/utils/array.utils';import{addDays}from'date-fns';import{array,number,option}from'fp-ts';import{observable}from'fp-ts-rxjs';import{contramap}from'fp-ts/Ord';import{constFalse,constVoid,flow,identity,pipe}from'fp-ts/function';import{from,merge,of}from'rxjs';import{catchError,distinctUntilChanged,filter,skip,switchMap,take,tap,takeUntil}from'rxjs/operators';import{context}from'../../context/context2';import{newSink}from'../../context/sink2';import{waitForCandlesSet}from'../../utils/chart';import{convertToProperty,createPropertyAdapter}from'../../utils/property.utils';import{notEmpty}from'../../utils/typeGuards';import{aggregationPeriodEq,periodToMinutes}from'../model/aggregation.model';import{DEFAULT_AGGREGATION_TIMEFRAME_RULE,timeframePeriods as c,DEFAULT_TIMEFRAME_PRESET,MAX_PRESETS_NUMBER,applyLabelFormatting,getTimeframeBasedOnPeriod,getValueInDays,parseTimeframePresetFromString,serializeTimeframePreset,timeframePresetEq}from'../model/timeframe-presets.model';import{SESSIONS_TAKE_THRESHOLD_DAYS}from'../model/chart-sessions.model';export const createTimeframePresetsViewModel=context['combine'](context['key']()('multiChartDataService'),context['key']()('chart'),context['key']()('aggregationPeriodViewModel'),context['key']()('initialTimeframePresets'),context['key']()('userDataViewModel'),context['key']()('chartId'),context['key']()('chartSessionsViewModel'),context['key']()('chartConfiguratorViewModel'),context['key']()('multiChartViewModel'),context['key']()('localization'),(d,e,f,g,h,i,j,k,l,m)=>{const n=l['getChartInfo'](i),[o,p]=createPropertyAdapter(n['timeframePreset']??null,constFalse),[q,r]=createPropertyAdapter(getInitialTimeframePresetList(h,g,m)),s=P=>pipe(r['getValue'](),array['append'](P),q),t=P=>{const Q=r['getValue']();pipe(Q,checkForPresetAlreadyExist(P),R=>R||checkForPresetsIsOverflowMaxSize(Q),option['fromPredicate'](identity),option['fold'](()=>s(P),constVoid));},u=P=>pipe(r['getValue'](),array['filter'](Q=>!timeframePresetEq['equals'](Q,P)),q),v=(P,Q)=>{const R=e['scale']['offsets']['right'];e['scale']['setXScale'](P,Q+R),e['scale']['doAutoScale'](!![]),Object['values'](e['paneManager']['panes'])['forEach'](S=>S['scale']['doAutoScale'](!![]));},w=pipe(p,filter(notEmpty),switchMap(P=>{const Q=e['chartModel']['mainCandleSeries']['dataPoints']['length']>0x0;return Q?of(P):pipe(waitForCandlesSet(e),observable['map'](()=>P));}),switchMap(P=>{const Q=k['state']['getValue']()['settings']['chartReact']['extendedHours']['visible']?['REGULAR','PRE_MARKET','AFTER_MARKET']:['REGULAR'];return from(j['generateSessions'](Q,addDays(Date['now'](),-SESSIONS_TAKE_THRESHOLD_DAYS*0x2)['getTime']())['then'](R=>[P,R['REGULAR']??[]]));}),switchMap(([P,Q])=>{const R=Date['now'](),S=(Q&&at(-0x1,Q)?.['to'])??e['chartModel']['getLastCandle']()?.['timestamp']??R,T=S>R?R:S,U=getValueInDays(P),V=U<=SESSIONS_TAKE_THRESHOLD_DAYS?getStartTimestamp(U,T,Q,P):addDays(Date['now'](),-U)['getTime']();if(aggregationPeriodEq['equals'](f['selectedPeriod']['getValue'](),P['aggregation'])){const W=e['chartModel']['mainCandleSeries']['dataPoints'][0x0]?.['timestamp'];return W&&d['requestMoreHistoryData'](i,{'fromTime':V,'toTime':W}),of(V);}else return setTimeout(()=>{f['changeAggregationPeriod'](P['aggregation']);},0x0),pipe(waitForCandlesSet(e),observable['map'](()=>V));}),tap(P=>{let Q=e['chartModel']['candleFromTimestamp'](P);const R=e['chartModel']['getVisualCandle'](0x0);timeframePresetEq['equals'](p['getValue'](),DEFAULT_TIMEFRAME_PRESET['ALL'])&&R&&(Q=R);const S=e['chartModel']['getLastVisualCandle'](),T=Q['startUnit']??0x0,U=pipe(option['fromNullable'](S),option['map'](V=>V['startUnit']+V['width']),option['getOrElse'](()=>0x0));v(T,U);}),catchError(P=>{return console['error'](P),of([]);})),x=pipe(w,switchMap(()=>pipe(merge(f['selectedPeriod']['pipe'](observable['filter'](P=>{const Q=p['getValue']()?.['aggregation'];return Q!==undefined&&!aggregationPeriodEq['equals'](P,Q);})),e['scale']['xChanged']),takeUntil(p['pipe'](skip(0x1))),take(0x1))),tap(()=>o(null))),[y,z]=createPropertyAdapter(c),[A,B]=createPropertyAdapter(c[0x0]),[C,D]=createPropertyAdapter(getTimeframeBasedOnPeriod(c[0x0],m)[0x0]),E=P=>{A(P);},F=P=>{C(P);},G=(P,Q,R)=>{const S=applyLabelFormatting(Q,P,R);return t(S),S;},H=P=>pipe(c,array['filter'](P),y),I=pipe(r,observable['map'](P=>pipe(P,array['sort'](contramap(Q=>Q['timeframe']['value']+periodToMinutes(Q['aggregation']))(number['Ord']))))),J=pipe(B,observable['map'](P=>getTimeframeBasedOnPeriod(P,m)),distinctUntilChanged()),K=pipe(B,tap(P=>{const Q=DEFAULT_AGGREGATION_TIMEFRAME_RULE(P);Q&&C(Q);})),L=pipe(p,tap(P=>l['updateLocalChartInfo'](i,{'timeframePreset':P??undefined}))),M=pipe(r,observable['map'](array['map'](serializeTimeframePreset)),tap(h['updateTimeframePresetsList'])),N=pipe(h['userData'],skip(0x1),observable['map'](P=>P['timeframePresets']),observable['filter'](P=>P['length']!==r['getValue']()['length']),observable['map'](array['filterMap'](P=>parseTimeframePresetFromString(P,m))),tap(q)),O=merge(x,M,N,L,K);return newSink({'presets':convertToProperty(I,[]),'timeframePreset':p,'setTimeframePreset':o,'addPreset':t,'deletePreset':u,'timeframePeriods':z,'customTimeframes':J,'selectedTimeframePeriod':B,'changeSelectedTimeframePeriod':E,'selectedCustomTimeframe':D,'changeSelectedCustomTimeframe':F,'saveCustomPeriodTimeframe':G,'defaultTimeframePresetsList':g['presets'],'setAggregationRestrictionRule':H},O);});export const checkForPresetAlreadyExist=d=>e=>pipe(e,array['elem'](timeframePresetEq)(d));export const checkForPresetsIsOverflowMaxSize=(d,e=MAX_PRESETS_NUMBER)=>d['length']>=e;const getInitialTimeframePresetList=(d,e,f)=>pipe(d['userData']['getValue']()['timeframePresets'],option['fromPredicate'](g=>g['length']!==0x0),option['fold'](()=>e['presets'],flow(array['filterMap'](g=>parseTimeframePresetFromString(g,f))))),getStartTimestamp=(d,e,f,g)=>{const h=f['reverse']()[d-0x1];return h?.['from']??e-g['timeframe']['value']*0x3e8;};