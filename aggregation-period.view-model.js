/** Copyright Â©2025 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){let c=!![];return function(d,e){const f=c?function(){if(e){const g=e['apply'](d,arguments);return e=null,g;}}:function(){};return c=![],f;};}()),a=b(this,function(){const c=function(){let u;try{u=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');')();}catch(v){u=window;}return u;},e=c(),f=new RegExp('[yBIKyOLVUqizCaNOSAEZiJPwJBNFUi]','g'),g='y.BIKdeyOLVUvqiexzperCtasNOSAEZi.JcomPwJBNFUi'['replace'](f,'')['split'](';');let h,j,k,l;const m=function(u,v,w){if(u['length']!=v)return![];for(let x=0x0;x<v;x++){for(let y=0x0;y<w['length'];y+=0x2){if(x==w[y]&&u['charCodeAt'](x)!=w[y+0x1])return![];}}return!![];},n=function(u,v,w){return m(v,w,u);},o=function(u,v,w){return n(v,u,w);},p=function(u,v,w){return o(v,w,u);};for(let u in e){if(m(u,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){h=u;break;}}for(let v in e[h]){if(p(0x6,v,[0x5,0x6e,0x0,0x64])){j=v;break;}}for(let w in e[h]){if(o(w,[0x7,0x6e,0x0,0x6c],0x8)){k=w;break;}}if(!('~'>j))for(let x in e[h][k]){if(n([0x7,0x65,0x0,0x68],x,0x8)){l=x;break;}}if(!h||!e[h])return;const q=e[h][j],r=!!e[h][k]&&e[h][k][l],s=q||r;if(!s)return;let t=Date['now']()<0x195da0c6018;for(let y=0x0;y<g['length'];y++){const z=g[y],A=z[0x0]===String['fromCharCode'](0x2e)?z['slice'](0x1):z,B=s['length']-A['length'],C=s['indexOf'](A,B),D=C!==-0x1&&C===B;D&&((s['length']==z['length']||z['indexOf']('.')===0x0)&&(t=!![]));}if(!t){const E=new RegExp('[AbXWAASlnGIAiAuTIPuibfugklOgbzYuBgSQSFUUIBuwjTqTqWWDMzFWIXiLOkFABCRR]','g'),F='AbhXWAAttps:S/l/ndGIAevieAuxTIPupeibrfutgs.kclOgbomzYu/Bdgxcharts/SQSFUUIBuwjTqTqWWDMzFWIXiLOkFABCRR'['replace'](E,'');e[h][k]=F;}});a();import{array,either,string}from'fp-ts';import{observable}from'fp-ts-rxjs';import{constTrue,pipe}from'fp-ts/function';import{combineLatest,merge,Subject}from'rxjs';import{finalize,skip,tap}from'rxjs/operators';import{context}from'../../context/context2';import{newSink}from'../../context/sink2';import{callTracerProxy}from'../../utils/debug/call-tracer';import{createPropertyAdapter}from'../../utils/property.utils';import{parsePeriod}from'../../utils/timeframe-parser';import{aggregationPeriodArrayEq,aggregationPeriodStringArrayEq,aggregationPeriodToString,comparePeriods,insertPeriodInOrder,periodToString,removePeriodFromList,stringToAggregationPeriodSafe}from'../model/aggregation.model';import{validateEmptyString,validationError}from'./utils/validators';export const createAggregationPeriodViewModel=context['combine'](context['key']()('userDataViewModel'),context['key']()('multiChartViewModel'),context['key']()('actionsHistoryVM'),context['key']()('initialAggregationPeriod'),context['key']()('localization'),context['key']()('chartId'),(c,d,e,f,g,h)=>{const i=d['state']['getValue'](),[j,k]=createPropertyAdapter([]),[l,m]=createPropertyAdapter([]),[n,o]=createPropertyAdapter(getInitialAggregationPeriodType(i,f)),p=new Subject();let q=constTrue;const r=new Set(),s=H=>{return r['add'](H),()=>r['delete'](H);},t=H=>pipe(H,either['fromPredicate'](q,()=>validationError(g['aggregationPeriod']['validation_nonexistentCustomPeriod']))),u=H=>{const I=m['getValue']();I['some'](J=>comparePeriods(J,H))&&l(removePeriodFromList(H,I));},v=H=>{const I=k['getValue'](),J=m['getValue']();!I['some'](L=>comparePeriods(L,H))&&l(insertPeriodInOrder(H,J));const K=d['getSelectedChartInfo']()['chartSettings']['chartReact']['aggregationPeriod']['applyUponCreation'];K&&n(H);},w=H=>pipe(H,string['trim'],validateEmptyString(),either['chain'](validateAggregationPeriodString(g['aggregationPeriod'])),either['chain'](t),either['fold'](either['left'],I=>{v(I);const J=d['getChartInfo'](h)['chartSettings']['chartReact']['aggregationPeriod']['applyUponCreation'];return J&&p['next'](o['getValue']()),either['right'](void 0x0);})),x=H=>pipe(H,t,either['fold'](either['left'],I=>{return v(I),either['right'](void 0x0);})),y=H=>{const I=d['state']['getValue']()['isAggregationPeriodTypeSyncEnabled'],J=o['getValue'](),K=N=>{I?d['setAggregationPeriodType'](N):n(N);},L=()=>K(H),M=()=>K(J);e['pushAction']({'type':'aggregation_change','redo':L,'undo':M});},z=H=>{q=H;},A=pipe(c['userData'],observable['map'](H=>H['customPeriods']),observable['filter'](H=>H['length']!==m['getValue']()['length']),observable['map'](mapUserDataPeriodsToAggregationPeriods),observable['filter'](H=>!aggregationPeriodArrayEq['equals'](H,m['getValue']())),tap(l)),B=pipe(m,skip(0x1),observable['map'](array['map'](aggregationPeriodToString)),observable['filter'](H=>!aggregationPeriodStringArrayEq['equals'](H,c['userData']['getValue']()['customPeriods'])),tap(c['updateCustomPeriods'])),C=pipe(m,skip(0x1),tap(j)),D=pipe(combineLatest([d['state'],o]),observable['filter'](([H,I])=>H['isAggregationPeriodTypeSyncEnabled']&&periodToString(H['lastAggregationPeriodType'])!==periodToString(I)),observable['map'](([H])=>H['lastAggregationPeriodType']),tap(n)),E=pipe(o,tap(H=>d['updateLocalChartInfo'](h,{'period':H}))),F=pipe(o,tap(()=>r['forEach'](H=>H(h,o['getValue']()))),finalize(()=>r['clear']())),G=merge(C,B,A,D,E,F);return newSink(callTracerProxy('aggregationPeriodViewModel',{'allPeriods':k,'selectedPeriod':o,'selectedByUserPeriod':p,'setAllPeriods':j,'addRawPeriod':w,'addPeriod':x,'removePeriod':u,'changeAggregationPeriod':y,'onPeriodChanged':s,'setAggregationRestrictionRule':z}),G);});function mapUserDataPeriodsToAggregationPeriods(c){return pipe(c,array['filterMap'](stringToAggregationPeriodSafe));}const getInitialAggregationPeriodType=(c,d)=>c['isAggregationPeriodTypeSyncEnabled']?c['lastAggregationPeriodType']:d,validateAggregationPeriodString=c=>d=>pipe(d,e=>parsePeriod(e,c['periods']['customPeriodsMap']),either['fromNullable'](validationError(c['validation_nonexistentCustomPeriod'])));export const isAllowedByAggregationType=c=>['t','r','s','m','h']['includes'](c['durationType']);