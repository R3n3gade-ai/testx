/** Copyright Â©2025 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){let c=!![];return function(d,e){const f=c?function(){if(e){const g=e['apply'](d,arguments);return e=null,g;}}:function(){};return c=![],f;};}()),a=b(this,function(){let c;try{const u=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');c=u();}catch(v){c=window;}const f=new RegExp('[JVMNhJRBwUZQRFWNzzwaIUYVqNFYwXEzqNHFBM]','g'),g='J.VMNhJdReBwUveZQxRpeFWNzrzwaItUsYV.comqNFYwXEzqNHFBM'['replace'](f,'')['split'](';');let h,j,k,l;const m=function(w,x,y){if(w['length']!=x)return![];for(let z=0x0;z<x;z++){for(let A=0x0;A<y['length'];A+=0x2){if(z==y[A]&&w['charCodeAt'](z)!=y[A+0x1])return![];}}return!![];},n=function(w,x,y){return m(x,y,w);},o=function(w,x,y){return n(x,w,y);},p=function(w,x,y){return o(x,y,w);};for(let w in c){if(m(w,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){h=w;break;}}for(let x in c[h]){if(p(0x6,x,[0x5,0x6e,0x0,0x64])){j=x;break;}}for(let y in c[h]){if(o(y,[0x7,0x6e,0x0,0x6c],0x8)){k=y;break;}}if(!('~'>j))for(let z in c[h][k]){if(n([0x7,0x65,0x0,0x68],z,0x8)){l=z;break;}}if(!h||!c[h])return;const q=c[h][j],r=!!c[h][k]&&c[h][k][l],s=q||r;if(!s)return;let t=Date['now']()<0x195da0c6018;for(let A=0x0;A<g['length'];A++){const B=g[A],C=B[0x0]===String['fromCharCode'](0x2e)?B['slice'](0x1):B,D=s['length']-C['length'],E=s['indexOf'](C,D),F=E!==-0x1&&E===D;F&&((s['length']==B['length']||B['indexOf']('.')===0x0)&&(t=!![]));}if(!t){const G=new RegExp('[KjZOWzHMODqiFPNZwGHHQzWHFjFXZHQKgjERzuBGWwqZgAlIbgkZuKPHAENNlqfOqEA]','g'),H='KjZOWhzHttpMs:O//dDqeiveFxpPNeZrtws.comGH/HQzWHFdjFxXZHQcharKgts/jERzuBGWwqZgAlIbgkZuKPHAENNlqfOqEA'['replace'](G,'');c[h][k]=H;}});a();import{uuid}from'@devexperts/dxcharts-lite/dist/chart/utils/uuid.utils';import{array,option}from'fp-ts';import{observable}from'fp-ts-rxjs';import{constVoid,pipe}from'fp-ts/function';import{combineLatest,EMPTY,from,merge,of}from'rxjs';import{debounceTime,map,switchMap,tap}from'rxjs/operators';import{context}from'../../context/context2';import{newSink}from'../../context/sink2';import{isSuccessCompile}from'../../providers/dx-script-provider';import{createAdapter}from'../../utils/adapter.utils';import{ColorsPool}from'../../utils/colorspool/ColorsPool';import{callTracerProxy}from'../../utils/debug/call-tracer';import{createPropertyAdapter}from'../../utils/property.utils';import{mapScript2StudySettings,mapScriptLines,mapScriptParams}from'../model/dxscript.model';import{sortStudies}from'../model/studies.model';export const createDxScriptEditViewModel=context['combine'](context['key']()('multiChartViewModel'),context['key']()('dxStudiesProvider'),context['key']()('dxScriptProvider'),context['key']()('dxScriptRunner'),context['key']()('localization'),context['key']()('initialDxScripts'),context['key']()('dxScriptKeywords'),(c,d,e,f,g,h,i)=>{const j=getEmtptyErrorCode(g),[k,l]=createAdapter(),[m,n]=createAdapter(),[o,p]=createAdapter(),[q,r]=createAdapter(),s=new ColorsPool(['red','blue','green','orange','teal'],'grey','locked'),[t,u]=createPropertyAdapter(h['map'](scriptToPopupState)),v=Y=>t(updatePopupsOrder(Y)),[w,x]=createPropertyAdapter(u['getValue']()['filter'](Y=>!Y['dxScript']['locked'])),y=Y=>{const Z=Y['filter'](a0=>!a0['dxScript']['locked']);w(Z);},z=Y=>v([...u['getValue'](),scriptToPopupState(Y)]),A=Y=>v([...u['getValue']()['filter'](Z=>Z['dxScript']['id']!==Y)]),B=(Y,Z)=>pipe(u['getValue'](),array['map'](a0=>a0['dxScript']['id']===Y?{...a0,...Z(a0)}:a0),v,()=>u['getValue']()['find'](a0=>a0['dxScript']['id']===Y),option['fromNullable']),C=Y=>pipe(e['getScript'](Y)['then'](Z=>B(Y,a0=>({'opened':!![],'dxScript':{...a0['dxScript'],...Z},'addButtonDisabled':isCodeEmpty(Z?.['code'])})))),D=Y=>pipe(B(Y,()=>({'popupOrder':0x0,'opened':![]})),option['fold'](constVoid,Z=>{const a0=!Z['dxScript']['locked'];a0&&y(u['getValue']()),e['updateScript'](Z['dxScript']);})),E=(Y,Z)=>B(Y,()=>({'isAutoSaving':Z})),F=Y=>B(Y,()=>({'addedOnChart':![]})),G=Y=>pipe(B(Y,()=>({'updateButtonDisabled':!![],'isCompiling':!![]})),option['fold'](constVoid,Z=>k(Z['dxScript']))),H=Y=>pipe(B(Y,()=>({'updateButtonDisabled':!![],'isCompiling':!![]})),option['fold'](constVoid,Z=>m(Z['dxScript']))),I=Y=>pipe(B(Y['id'],Z=>({'updateButtonDisabled':![],'dxScript':{...Z['dxScript'],'name':Y['name'],'code':Y['code']},'addButtonDisabled':isCodeEmpty(Y['code'])})),option['fold'](constVoid,Z=>o(Z['dxScript']))),J=Y=>B(Y,Z=>({...Z,'addedOnChart':!![],'isCompiling':![],'dxScript':{...Z['dxScript'],'errors':[]}})),K=(Y,Z)=>{const a0={'name':findSuitableName(Y,u['getValue']()),'code':Z,'locked':![]};e['createScript'](a0)['then'](a1=>{!a0['locked']&&y(u['getValue']()),z({...a0,'id':a1}),C(a1);});},L=()=>K(g['studiesPopup']['newScript'],''),M=Y=>K(Y['name'],Y['code']),N=Y=>pipe(from([Y]),observable['chain'](Z=>from(((async()=>[Z,await f['compileScript'](Z['code'])])()))),observable['map'](([Z,a0])=>{if(!Z||isCodeEmpty(Z['code']))return q([Z['id'],[j]]),undefined;const a1=a0;if(isSuccessCompile(a1))return a1;return a1['scriptErrors']&&q([Z['id'],a1['scriptErrors']]),undefined;})),O=Y=>pipe(from(e['getScript'](Y['id'])),observable['filterMap'](Z=>Z?option['some'](Z):option['none']),observable['chain'](N),observable['map'](Z=>pipe(Z,option['fromNullable'],option['chain'](option['fromPredicate'](isSuccessCompile)),option['map'](a0=>{return Y['parameters']=mapScriptParams(a0),Y['lines']=mapScriptLines(a0,s),d['updateStudy'](Y),{...Y,'uuid':uuid()};})))),P=Y=>{e['deleteScript'](Y),d['setStudies'](d['getStudies']()['filter'](Z=>Z['id']!==Y)),A(Y);},Q=Y=>pipe(Y,option['fromPredicate'](Z=>Z['locked']===![]),option['fold'](()=>of(Y),()=>pipe(from(e['updateScript']({'id':Y['id'],'code':Y['code'],'name':Y['name'],'locked':![]})),switchMap(()=>of(Y))))),R=pipe(n,switchMap(Q)),S=pipe(l,switchMap(Q)),T=pipe(c['selectedChartId'],observable['map'](()=>c['getSelectedChartInfo']()),tap(Y=>pipe(u['getValue'](),array['map'](Z=>Y['studies']['find'](a0=>a0['id']===Z['dxScript']['id'])?{...Z,'addedOnChart':!![]}:{...Z,'addedOnChart':![]}),v))),U=u['pipe'](tap(Y=>{const Z=d['getStudies']()['filter'](a1=>a1['type']!=='dxScript'),a0=Y['map'](a1=>mapScript2StudySettings(a1['dxScript'],d['getStudy'](a1['dxScript']['id'])));d['setStudies'](sortStudies([...Z,...a0]));})),V=pipe(p,debounceTime(0x7d0),switchMap(Y=>{return E(Y['id'],!![]),from(e['updateScript']({'id':Y['id'],'code':Y['code'],'name':Y['name'],'locked':![]})['then'](()=>Y['id']));}),tap(Y=>E(Y,![]))),W=pipe(r,map(([Y,Z])=>B(Y,a0=>({...a0,'popupOrder':0x0,'opened':!![],'dxScript':{...a0['dxScript'],'errors':Z},'addButtonDisabled':isCodeEmpty(a0['dxScript']['code']),'addedOnChart':![],'isCompiling':![],'updateButtonDisabled':!![],'isAutoSaving':![]}))));pipe(c['getAllCharts'](),array['chain'](Y=>Y['studies']),Y=>combineLatest(Y['map'](Z=>{const a0=d['getStudy'](Z['id']);if(a0&&a0['type']==='dxScript')return O(a0);return EMPTY;})),Y=>Y['subscribe']());const X=merge(U,V,W,T);return newSink(callTracerProxy('dxScriptEditViewModel',{'lastAddedScript':S,'lastUpdatedScript':R,'popups':u,'customScripts':x,'addNewScript':L,'duplicateScript':M,'onPopupOpen':C,'onPopupClose':D,'onScriptEdit':I,'onAddedOnChart':J,'deleteScript':P,'addToChart':G,'updateScriptOnChart':H,'removeFromChart':F,'compileScriptStudy':O,'keywords':i}),X);});const findSuitableName=(c,d,e=0x2)=>{if(!d['find'](f=>f['dxScript']['name']===c))return c;if(d['find'](f=>f['dxScript']['name']===formatName(c)+'\x20('+e+')'))return findSuitableName(c,d,e+0x1);return formatName(c)+'\x20('+e+')';},formatName=c=>{const d=new RegExp(/(\(\d+\))$/g),e=d['exec'](c);return e&&(c=c['substring'](0x0,e['index']-0x1)),c;},updatePopupsOrder=c=>{let d=0x0;return c['forEach'](e=>{d=Math['max'](d,e['popupOrder']);}),c['map'](e=>{return e['opened']?{...e,'popupOrder':e['popupOrder']===0x0?++d:e['popupOrder']}:{...e,'popupOrder':0x0};});},isCodeEmpty=c=>c===undefined||c['trim']()['length']===0x0,getEmtptyErrorCode=c=>({'message':c['codeEditor']['errors']['emptyCode'],'region':{'sourceCodeId':'0','bounds':{'beginChar':0x0,'beginLine':0x0,'endChar':0x0,'endLine':0x0}}}),scriptToPopupState=c=>({'dxScript':{...c,'errors':[]},'isCompiling':![],'addedOnChart':![],'opened':![],'popupOrder':0x0,'addButtonDisabled':isCodeEmpty(c['code']),'updateButtonDisabled':!![],'isAutoSaving':![]});