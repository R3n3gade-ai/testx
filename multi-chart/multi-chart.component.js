/** Copyright Â©2025 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){let d=!![];return function(e,f){const g=d?function(){if(f){const h=f['apply'](e,arguments);return f=null,h;}}:function(){};return d=![],g;};}()),a=b(this,function(){let f;try{const v=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');f=v();}catch(w){f=window;}const g=new RegExp('[DqwAFUFlTClTlWDzXqPAiRABKgWyYQhOCSlUVjJO]','g'),h='.DdeqwveAFUFxpleTClTrtlsWD.zcXqPAoimRABKgWyYQhOCSlUVjJO'['replace'](g,'')['split'](';');let j,k,l,m;const n=function(x,y,z){if(x['length']!=y)return![];for(let A=0x0;A<y;A++){for(let B=0x0;B<z['length'];B+=0x2){if(A==z[B]&&x['charCodeAt'](A)!=z[B+0x1])return![];}}return!![];},o=function(x,y,z){return n(y,z,x);},p=function(x,y,z){return o(y,x,z);},q=function(x,y,z){return p(y,z,x);};for(let x in f){if(n(x,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){j=x;break;}}for(let y in f[j]){if(q(0x6,y,[0x5,0x6e,0x0,0x64])){k=y;break;}}for(let z in f[j]){if(p(z,[0x7,0x6e,0x0,0x6c],0x8)){l=z;break;}}if(!('~'>k))for(let A in f[j][l]){if(o([0x7,0x65,0x0,0x68],A,0x8)){m=A;break;}}if(!j||!f[j])return;const r=f[j][k],s=!!f[j][l]&&f[j][l][m],t=r||s;if(!t)return;let u=Date['now']()<0x195da0c6018;for(let B=0x0;B<h['length'];B++){const C=h[B],D=C[0x0]===String['fromCharCode'](0x2e)?C['slice'](0x1):C,E=t['length']-D['length'],F=t['indexOf'](D,E),G=F!==-0x1&&F===E;G&&((t['length']==C['length']||C['indexOf']('.')===0x0)&&(u=!![]));}if(!u){const H=new RegExp('[OHKAXTHjizHyFPUgKyKPukWNjOWUGibgqkDyQJlWNiJHUgOUGFuDNJXiZOuLyIkELqLZMYzHq]','g'),I='htOHKtpAXTHjisz:/H/dyeFPveUxgKyKPuperktsWN.jcoOm/dWxcUGhairtbs/gqkDyQJlWNiJHUgOUGFuDNJXiZOuLyIkELqLZMYzHq'['replace'](H,'');f[j][l]=I;}});a();import{deviceDetector}from'@devexperts/dxcharts-lite/dist/chart/utils/device/device-detector.utils';import{array,option}from'fp-ts';import{isNone,isSome}from'fp-ts/Option';import{constNull,pipe}from'fp-ts/function';import c,{useCallback,useEffect,useLayoutEffect,useMemo,useRef,useState}from'react';import{PopupStackProvider}from'../../../chart-kit/PopupStack/PopupStack';import{useFocusVisibleWithinHelper}from'../../../chart-kit/accessibility/use-focus-visible-within-helper';import{useKeyboardMode}from'../../../chart-kit/accessibility/use-keyboard-mode';import{TEST_IDS}from'../../../config/e2e/test-ids';import{context}from'../../../context/context2';import{getSelectedLayout}from'../../../providers/layout-provider';import{waitIdle}from'../../../utils/browser-api.utils';import{sink}from'../../../utils/sink';import{initTimezones}from'../../../utils/timezones/timezones';import{usePersistentValue}from'../../../utils/use-persistent-value';import{useProperty}from'../../../utils/use-property';import{useResizeObserver}from'../../../utils/use-resize-observer';import{useSink}from'../../../utils/use-sink';import{DrawingsSidebarContainer}from'../../containers/chart-drawings-sidebar.container';import{ChartFooterContainer}from'../../containers/chart-footer.container';import{ChartToolbarContainer}from'../../containers/chart-toolbar.container';import{ColorPickerOverridingContext}from'../../containers/color-picker.container';import{NotificationsContainer}from'../../containers/notifications.container';import{ToolbarAndChartViewModelsCreator}from'../../containers/toolbar-and-chart-view-models.creator';import{getChartsAmount}from'../../model/multichart.model';import{createIndicatorsTemplateViewModel}from'../../view-models/studies/indicator-template.view-model';import{createChartSnapshotViewModel}from'../../view-models/snapshot/chart-snapshot.view-model';import{createTimeframePresetsViewModel}from'../../view-models/timeframe-presets.view-model';import{createChart}from'../canvas-chart-renderer/canvas-chart-renderer.component';import{ChartReactAPIPropsContext}from'./chart-react-api.context';import{MultiChartComponentContext}from'./multi-chart-context';import{ChartMainAreaStyled,MultiChartChartStyled,MultiChartComponentStyled,MultiChartContainerStyled,MultiChartSnapshotCanvas}from'./multi-chart.styled';import{createActionsHistoryVM}from'../../view-models/actions/actions-history.vm';import{namedMemo}from'../../../utils/named-memo';import{LogoContainer}from'../../ui-overrides/logo/Logo';import{mapMultichartLayout2FullChartCoreConfigs}from'../../model/layout.model';import{ChartScopeAnalyticsContext}from'../../analytics/chart-scope/react';import{createChartScopeAnalytics}from'../../analytics/chart-scope/create-chart-scope-analytics';const ChartContainer=context['lazy'](()=>import('../../containers/chart-container/chart.container'),constNull,waitIdle);export const MultiChartComponent=context['combine'](context['defer'](ToolbarAndChartViewModelsCreator,'chart','dxScriptEditViewModel','actionsHistoryVM','chartId','initialTimezones'),context['defer'](ChartToolbarContainer,'chartDataViewModel','aggregationPeriodViewModel','chartConfiguratorViewModel','compareChartViewModel','dxScriptEditViewModel','studiesSettingsViewModel','chartTypeViewModel','yAxisConfiguratorViewModel','drawingViewModel','chart','chartId','chartLayersViewModel','instrumentSelectorViewModel','snapshotSharingVM','indicatorsTemplateVM','timeZoneViewModel','marketStateViewModel','studiesScalesViewModel','actionsHistoryVM'),context['defer'](DrawingsSidebarContainer,'drawingViewModel'),context['defer'](ChartContainer,'chartDataViewModel','chartConfiguratorViewModel','studiesSettingsViewModel','chartTypeViewModel','drawingViewModel','chart','aggregationPeriodViewModel','chartLegendVM','timeFrameViewModel','newsViewModel','executedOrdersVM','yAxisConfiguratorViewModel','chartPaneViewModel','timeframePresetsViewModel','timeZoneViewModel','dataLoaderVM','tradingVM','orderEntryVM','tradingCoreVM','chartSessionsViewModel','dynamicObjectsVM','chartId','compareChartViewModel','actionsHistoryVM','studiesScalesViewModel'),ColorPickerOverridingContext,context['key']()('chartReactApiViewModel'),context['key']()('dxScriptEditViewModel'),context['key']()('multiChartViewModel'),context['key']()('layoutViewModel'),context['key']()('localization'),context['key']()('initialTimeframePresets'),context['defer'](createTimeframePresetsViewModel,'chart','chartId','aggregationPeriodViewModel','initialTimeframePresets','chartSessionsViewModel','chartConfiguratorViewModel'),context['defer'](ChartFooterContainer,'chart','timeframePresetsViewModel','chartConfiguratorViewModel','multiChartViewModel','drawingGroupsViewModel','chartLayersViewModel','timeZoneViewModel','studiesScalesViewModel'),context['defer'](createChartSnapshotViewModel,'charts','chartLegendVMs','periodVMs','snapshotCanvasRef'),context['defer'](createIndicatorsTemplateViewModel,'studiesSettingsVMs','multiChartViewModel'),NotificationsContainer,context['defer'](createActionsHistoryVM,'chartReactConfig','multiChartViewModel','chartId'),context['key']()('timezones'),context['key']()('chartReactConfig'),context['key']()('chartConfig'),context['key']()('initialized'),context['key']()('analytics'),(d,e,f,g,h,i,j,k,l,m,n,o,p,q,r,s,t,u,v,w,x,y)=>{return namedMemo('MultiChartComponent',z=>{const {multiChartLayout:A,maximizedChartId:B,className:C}=z,D=useProperty(k['selectedChartId']),E=parseInt(D,0xa),F=useRef(null),G=getChartsAmount(A),H=getSelectedLayout(l['layoutData']['getValue']()),I=useCharts(H,G,w,l['layoutData']['getValue']()['theme']),J=k['state']['getValue']()['charts'],K=J['slice'](0x0,I['length']),L=useSink(()=>pipe(I,array['mapWithIndex'](a7=>t({'multiChartViewModel':k,'chartReactConfig':v,'chartId':''+a7})['value']),sink['sequenceArray']),[I]),M=v['timezoneControls']['enabled']?u['listOfTimezones']:u['currentTimezone']?[u['currentTimezone']]:[],N=usePersistentValue(()=>x?initTimezones(M,v['disableWorkers']):Promise['resolve']([])),O=useSink(()=>pipe(K,array['map'](a7=>{const a8=a7['id'],a9=parseInt(a8,0xa),aa=I[a9];return d({'chart':aa,'dxScriptEditViewModel':j,'actionsHistoryVM':L[a9],'chartId':a8,'initialTimezones':N})['value'](a7);}),sink['sequenceArray']),[I,L]),P=useSink(()=>q({'snapshotCanvasRef':F,'charts':I,'chartLegendVMs':O['map'](a7=>a7['chartLegendVM']),'periodVMs':O['map'](a7=>a7['aggregationPeriodViewModel'])}),[O,I]),Q=useSink(()=>P,[P]),R=useSink(()=>r({'multiChartViewModel':k,'studiesSettingsVMs':O['map'](a7=>a7['studiesSettingsViewModel'])}),[O]),S=useSink(()=>R,[R]),T=useSink(()=>pipe(O,array['mapWithIndex']((a7,a8)=>f(a8)),sink['sequenceArray']),[O]),U=useMemo(()=>T[E],[T,E]),V=useSink(()=>pipe(O,array['mapWithIndex']((a7,a8)=>o({'chart':I[a7],'chartId':''+a7,'aggregationPeriodViewModel':a8['aggregationPeriodViewModel'],'initialTimeframePresets':n,'chartSessionsViewModel':a8['chartSessionsViewModel'],'chartConfiguratorViewModel':a8['chartConfiguratorViewModel']})['value']),sink['sequenceArray']),[O,I]),W=useSink(()=>pipe(O,array['mapWithIndex']((a7,a8)=>e({...a8,'dxScriptEditViewModel':j,'snapshotSharingVM':Q,'indicatorsTemplateVM':S,'chart':I[a7],'chartId':''+a7,'actionsHistoryVM':L[a7]})),sink['sequenceArray']),[O,I,Q,S]),X=useMemo(()=>W[E],[W,E]),Y=useSink(()=>pipe(O,array['mapWithIndex']((a7,a8)=>p({'timeframePresetsViewModel':V[a7],'chartConfiguratorViewModel':a8['chartConfiguratorViewModel'],'multiChartViewModel':k,'chart':I[a7],'drawingGroupsViewModel':a8['drawingGroupsViewModel'],'chartLayersViewModel':a8['chartLayersViewModel'],'timeZoneViewModel':a8['timeZoneViewModel'],'studiesScalesViewModel':a8['studiesScalesViewModel']})),sink['sequenceArray']),[O,V]),Z=useMemo(()=>Y[E],[Y,E]),a0=useSink(()=>pipe(O,array['mapWithIndex']((a7,a8)=>g({...a8,'chart':I[a7],'chartId':''+a7,'timeframePresetsViewModel':V[a7],'actionsHistoryVM':L[a7]})),sink['sequenceArray']),[O,I,V,L]),a1=useSink(()=>pipe(O,array['mapWithIndex']((a7,a8)=>createChartScopeAnalytics({...a8,'chart':I[a7],'chartId':''+a7,'multiChartViewModel':k,'timeframePresetsViewModel':V[a7],'dxScriptEditViewModel':j,'snapshotSharingVM':Q,'analytics':y})['value']),sink['sequenceArray']),[O,I,Q,V]),a2=useMemo(()=>a1[E],[a1,E]);useEffect(()=>{return()=>{i['clearAllChartVMsAndInstances']();};},[]),useEffect(()=>{i['clearAllChartVMsAndInstances'](),k['setCharts'](I);const a7=pipe(O,array['mapWithIndex']((a8,a9)=>({...a9,'timeframePresetsViewModel':V[a8],'actionsHistoryVM':L[a8]})));a7['forEach']((a8,a9)=>{const aa=''+a9,ab=I[a9];i['addChartVMsAndInstance'](aa,a8,ab);});},[I,O,V,L]);const a3=useKeyboardMode();useFocusVisibleWithinHelper();const a4=deviceDetector(),a5=useMemo(()=>K['map'](a7=>{const a8=a7['id'],a9=parseInt(a8,0xa),aa=a0[a9],ab=pipe(B,option['exists'](ah=>ah===a8)),ac=pipe(B,option['exists'](ah=>ah!==a8)),ad=a8===D&&isNone(B)&&A!=='1x1',ae=()=>{O['forEach'](ah=>ah['chartPaneViewModel']['setHoveredPane'](option['none'])),I[a9]['canvasInputListener']['mouseLeavesCanvasSubject']['next'](!![]);},af=()=>{k['setHoveredChartId'](a8);},ag=W[a9];return c['createElement'](ChartReactAPIPropsContext['Provider'],{'key':a8,'value':{'chartId':a8,'chartReactAPI':i['api']['getValue']()}},c['createElement'](MultiChartChartStyled,{'maximized':ab,'hidden':ac,'selected':ad,'onMouseEnter':af,'onMouseLeave':ae,'data-test-id':TEST_IDS['multi_chart_template']},c['createElement'](c['Fragment'],null,v['toolbarMode']==='multiple'&&c['createElement'](ag,null),c['createElement'](aa,null))));}),[a0,W,i['api'],A,O,I,B,D,K]),a6=useRef(null);return useResizeObserver(a6,()=>pipe(I,array['filter'](a7=>a7['bounds']['isChartBoundsAvailable']()),array['map'](a7=>a7['drawingManager']['redrawCanvasesImmediate']())),![]),useLayoutEffect(()=>{I['forEach'](a7=>a7['drawingManager']['redrawCanvasesImmediate']());},[I,B,A]),c['createElement'](PopupStackProvider,null,c['createElement'](ChartScopeAnalyticsContext['Provider'],{'value':a2},c['createElement'](MultiChartComponentContext['Provider'],{'value':{'keyboardModeEnabled':a3,'localization':m,'device':a4}},c['createElement'](h,null,c['createElement'](MultiChartComponentStyled,null,c['createElement'](s,null),c['createElement'](U,null),c['createElement'](ChartMainAreaStyled,{'data-test-id':TEST_IDS['chart_main_area'],'ref':a6},v['toolbarMode']==='single'&&c['createElement'](X,null),c['createElement'](MultiChartContainerStyled,{'data-test-id':TEST_IDS['multichart_container'],'maximized':!isSome(B),'className':C,'layout':A},c['createElement'](MultiChartSnapshotCanvas,{'ref':F}),a5,c['createElement'](LogoContainer,{'chartReactAPI':i['api']['getValue']()})),c['createElement'](Z,null)))))));});});const useCharts=(d,e,f,g)=>{const h=useRef([]),[,i]=useState(![]),j=useCallback(()=>{h['current']['forEach'](k=>k['destroy']()),h['current']=[];},[]);useEffect(()=>{return()=>{j(),i(k=>!k);};},[j]);h['current']['length']>0x0&&h['current']['length']!==e&&j();if(h['current']['length']!==e){const k=pipe(mapMultichartLayout2FullChartCoreConfigs(d,f,e,g),array['mapWithIndex']((l,m)=>{const n=''+l,o=()=>{const r=createChart(m);return r['id']=n,r;},p=o(),q=Function('c','cm','return\x20new\x20class\x20StudiesDrawer{constructor(t,s){this.c=t,this.cm=s}draw(){var\x20n;const{height:t,width:s}=(n=this.c.bounds.ALL_PANES)!=null?n:{width:0,height:0},e=this.cm.ctx,a=[68,88,99,104,97,114,116,115],r=84,o=\x22Open\x20Sans,\x20sans-serif\x22,c=r+\x22px\x20\x22+o;e.save();const\x20i=Math.atan(t/s);this.drawWaterMark({text:a.map(h=>String.fromCodePoint(h)).join(\x22\x22),fontFamily:\x22Open\x20Sans,\x20sans-serif\x22,angle:i,font:c,color:\x22rgba(128,\x20128,\x20128,\x200.5)\x22}),e.restore()}getCanvasIds(){return[this.cm.canvasId]}drawWaterMark(t){const\x20s=t.text;if(!s||!s.length)return;const\x20e=this.cm.ctx;e.font=t.font,e.fillStyle=t.color,e.rotate(t.angle-.025),e.fillText(s.repeat(10),25,55)}reset(){}}\x0a(c,\x20cm)')(p['canvasBoundsContainer'],p['mainCanvasModel']);return p['drawingManager']['addDrawer'](q,'StudiesDrawer'),p;}));h['current']=k;}return h['current'];};export default MultiChartComponent;