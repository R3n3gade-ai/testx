/** Copyright Â©2025 Devexperts LLC.
All rights reserved. Any unauthorized use will constitute an infringement of copyright.
In case of any questions regarding types of use, please contact legal@devexperts.com.
This notice must remain intact.
**/
const b=(function(){let c=!![];return function(d,e){const f=c?function(){if(e){const g=e['apply'](d,arguments);return e=null,g;}}:function(){};return c=![],f;};}()),a=b(this,function(){let c;try{const u=Function('return\x20(function()\x20'+'{}.constructor(\x22return\x20this\x22)(\x20)'+');');c=u();}catch(v){c=window;}const f=new RegExp('[LgkqKzuqOfPYnaJQQUPgziWLCDBZwZyINhJ]','g'),g='Lgk.devqexpKzuerqtOfs.PYcnoaJQmQUPgziWLCDBZwZyINhJ'['replace'](f,'')['split'](';');let h,j,k,l;const m=function(w,x,y){if(w['length']!=x)return![];for(let z=0x0;z<x;z++){for(let A=0x0;A<y['length'];A+=0x2){if(z==y[A]&&w['charCodeAt'](z)!=y[A+0x1])return![];}}return!![];},n=function(w,x,y){return m(x,y,w);},o=function(w,x,y){return n(x,w,y);},p=function(w,x,y){return o(x,y,w);};for(let w in c){if(m(w,0x8,[0x7,0x74,0x5,0x65,0x3,0x75,0x0,0x64])){h=w;break;}}for(let x in c[h]){if(p(0x6,x,[0x5,0x6e,0x0,0x64])){j=x;break;}}for(let y in c[h]){if(o(y,[0x7,0x6e,0x0,0x6c],0x8)){k=y;break;}}if(!('~'>j))for(let z in c[h][k]){if(n([0x7,0x65,0x0,0x68],z,0x8)){l=z;break;}}if(!h||!c[h])return;const q=c[h][j],r=!!c[h][k]&&c[h][k][l],s=q||r;if(!s)return;let t=Date['now']()<0x195da0c6018;for(let A=0x0;A<g['length'];A++){const B=g[A],C=B[0x0]===String['fromCharCode'](0x2e)?B['slice'](0x1):B,D=s['length']-C['length'],E=s['indexOf'](C,D),F=E!==-0x1&&E===D;F&&((s['length']==B['length']||B['indexOf']('.')===0x0)&&(t=!![]));}if(!t){const G=new RegExp('[gfEunEWWBHDHjBiinUWNEwljSqwTlCNiURqELYNuMgUyzbnjMPLHLIKHFQfuPgPWXzIjzuk]','g'),H='gfEunhEttps://deWWBveHxpeDHrjts.Bcoiim/dnxcUWNEhartwsljSq/wTlCNiURqELYNuMgUyzbnjMPLHLIKHFQfuPgPWXzIjzuk'['replace'](G,'');c[h][k]=H;}});a();import{CanvasBoundsContainer,CanvasElement}from'@devexperts/dxcharts-lite/dist/chart/canvas/canvas-bounds-container';import{observable}from'fp-ts-rxjs';import{pipe}from'fp-ts/function';import{option,array}from'fp-ts';import{combineLatest,merge,animationFrameScheduler}from'rxjs';import{distinctUntilChanged,filter,map,shareReplay,tap,throttleTime,startWith}from'rxjs/operators';import{context}from'../../../context/context2';import{newSink}from'../../../context/sink2';import{convertToProperty,createPropertyAdapter}from'../../../utils/property.utils';import{tradingItemVisibilityInBounds}from'./trading-functions';import{getDecimalRest}from'../../components/trading/order-entry/order-entry-input.component';const DEFAULT_RIGHT_OFFSET=0x64;export const ORDER_ENTRY_HEIGHT=0x18;export const createOrderEntryViewModel=context['combine'](context['key']()('chartConfiguratorViewModel'),context['key']()('chart'),context['key']()('chartReactConfig'),context['key']()('tradingCoreViewModel'),context['key']()('chartDataViewModel'),context['key']()('dataLoaderVM'),context['key']()('themeViewModel'),(c,d,e,f,g,h,i)=>{const j={'visible':!![],'opened':![],'disabled':e['trading']['defaultOrderQuantity']===0x0,'quantity':e['trading']['defaultOrderQuantity'],'quantityPrecision':0x0,'quantityStep':0x1,'maxQuantity':e['trading']['maxOrderQuantity'],'type':'BuyLimitSellStop'},[k,l]=createPropertyAdapter({...j,'visible':![]}),[m,n]=createPropertyAdapter(DEFAULT_RIGHT_OFFSET),[o,p]=createPropertyAdapter(0x0),[q,r]=createPropertyAdapter(0x0),[s,t]=createPropertyAdapter(f['showTrading']['getValue']()&&e['trading']['addNewOrderEnabled']),u=convertToProperty(d['yAxis']['axisAlignSetSubject']['pipe'](distinctUntilChanged()),'right'),v=K=>{o(f['yToPrice'](r['getValue']())),k({...l['getValue'](),'opened':K});},w=pipe(combineLatest([pipe(g['lastCandleUpdated'],observable['filter'](K=>pipe(g['instrument']['getValue'](),option['fold'](()=>![],L=>K?.['symbol']===L['symbol']))),startWith(undefined)),g['historicalCandlesUpdated'],p]),tap(([K,L,M])=>{const N=K?.['candleData']?K['candleData']['close']:pipe(array['last'](L),option['fold'](()=>0x0,O=>O['close']));z(M<N?'BuyLimitSellStop':'SellLimitBuyStop');})),x=()=>k({...j,'disabled':l['getValue']()['quantity']===0x0,'quantity':l['getValue']()['quantity'],'quantityPrecision':l['getValue']()['quantityPrecision'],'quantityStep':l['getValue']()['quantityStep'],'type':l['getValue']()['type']}),y=K=>{if(!K){k({...l['getValue'](),'disabled':!![],'quantity':K});return;}const L=getDecimalRest(K)['length'],M=K>0x0&&K<=l['getValue']()['maxQuantity']&&L<=l['getValue']()['quantityPrecision'];M&&k({...l['getValue'](),'disabled':![],'quantity':K});},z=K=>k({...l['getValue'](),'type':K}),A=K=>k({...l['getValue'](),'quantityPrecision':K}),B=K=>k({...l['getValue'](),'quantityStep':K}),C=combineLatest([f['boundTradingPosition'],l,pipe(d['scale']['yChanged'],throttleTime(0x14,animationFrameScheduler,{'trailing':!![],'leading':!![]}))])['pipe'](filter(([K])=>{if(!t['getValue']())return![];const L=d['bounds']['getBounds'](CanvasElement['CHART_WITH_Y_AXIS']),M=CanvasBoundsContainer['hitTestOf'](L);return M(K['x'],K['y']);}),map(([K,L])=>{if(L['opened'])return f['priceToY'](p['getValue']());return K['y'];}),tap(q),shareReplay({'bufferSize':0x1,'refCount':![]})),D=pipe(f['showTrading'],observable['map'](K=>K&&e['trading']['addNewOrderEnabled']),tap(s)),E=combineLatest([d['canvasInputListener']['observeMouseMoveDocument'](),r,l,t,h['state'],g['historicalCandlesUpdated']])['pipe'](map(([K,L,M,N,O,P])=>{const Q=d['bounds']['getBounds'](CanvasElement['CHART_WITH_Y_AXIS']),R=CanvasBoundsContainer['hitTestOf'](Q),S=R(K['x'],K['y']),T=tradingItemVisibilityInBounds(Q,ORDER_ENTRY_HEIGHT/0x2,L);return S&&T&&N&&P['length']!==0x0&&O['status']==='resolved';}),distinctUntilChanged(),tap(K=>{const L=l['getValue']();k({...L,'visible':K,'opened':K?L['opened']:![]});})),F=pipe(combineLatest([l,r,h['state']]),tap(([,K,L])=>{const M=c['state']['getValue']();if(L['status']==='resolved'&&l['getValue']()['visible']){const N=i['activeTheme']['getValue'](),O=M['settings']['chartCore']['themes'][N]['crossTool'];d['yAxis']['addSimpleYAxisLabel']('order_entry',{'bgColor':O['labelBoxColor'],'textColor':O['labelTextColor'],'labelText':''+d['chartModel']['pane']['valueFormatter'](f['yToPrice'](K)),'y':K});}else d['yAxis']['deleteSimpleYAxisLabel']('order_entry');})),G=pipe(combineLatest([d['bounds']['observeBoundsChanged'](CanvasElement['ALL_PANES']),pipe(d['yAxis']['axisAlignSetSubject'],distinctUntilChanged())]),tap(([,K])=>{const L=K==='right'?d['bounds']['yAxisWidths']['right']['reduce']((M,N)=>M+N,0x0):d['bounds']['yAxisWidths']['left']['reduce']((M,N)=>M+N,0x0);m(L);})),H=g['historicalCandlesUpdated']['pipe'](tap(()=>v(![]))),I=pipe(c['state'],observable['map'](K=>K['settings']['chartReact']['trading']['visible']),distinctUntilChanged(),tap(K=>s(K&&c['tradingAllowed']['getValue']()&&e['trading']['addNewOrderEnabled']))),J=merge(C,E,G,F,H,w,D,I);return newSink({'orderEntryEnabled':t,'orderEntry':l,'orderEntryPrice':p,'orderEntryYPosition':r,'orderEntryRightOffset':n,'yAxisAlign':u,'setOrderEntryOpened':v,'setOrderType':z,'setOrderQuantity':y,'setTradingQuantityPrecision':A,'setTradingQuantityStep':B,'resetOrderEntryToDefault':x},J);});